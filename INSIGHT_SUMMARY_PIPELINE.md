# InsightSummary 생성 파이프라인

이 문서는 **리뷰 InsightSummary**가 생성되는 전체 흐름을 설명합니다.  
InsightSummary는 단순 요약이 아니라, **입력 검증 → 전처리 → Corpus 구성 → 요약 모델(T5) → 한국어 후처리**로 이어지는 파이프라인을 통해 생성됩니다.

본 파이프라인은 **Java → Python 분석 요청** 구조에서,  
Python 분석 서버가 담당하는 **요약 생성 로직의 기준 문서** 역할을 합니다.

---

## 1. 파이프라인 개요

InsightSummary 생성은 아래 단계로 구성됩니다.

1. 입력 검증 (안전장치)
2. 리뷰 텍스트 전처리
3. Corpus 구성 (요약 대상 텍스트)
4. T5 요약 모델 실행
5. 후처리 (존댓말 · 띄어쓰기 · 문장부호)

---

## 2. 입력 검증 (Validation)

요약 품질 이전에 **서버 안정성**을 우선 보장합니다.

### 검증 항목
- 리뷰 개수 제한 (`MAX_REVIEWS`)
- 리뷰 코멘트 길이 제한 (`MAX_COMMENT_LEN`)

### 목적
- 과도한 입력으로 인한 모델 추론 지연 방지
- 메모리 사용량 및 비용 폭증 방지
- 악의적/비정상 요청 차단

검증 실패 시 **HTTP 400**으로 즉시 종료됩니다.

---

## 3. 입력 전처리 (Sanitize & Normalize)

리뷰 코멘트는 모델 입력 전에 **의미 없는 노이즈와 지시문을 제거**합니다.

### 주요 전처리 로직
- 코드 블록 / 백틱 제거
- 모델 토큰 흔적(`<s>`, `▁`) 제거
- Markdown 헤더(`##`) 제거
- 프롬프트/지시문으로 보이는 라인 제거
    - 예: `요약해줘`, `system:`, `instruction:` 등
- 공백 정규화
- 너무 짧은 텍스트 제거

### 효과
- 프롬프트 주입 방지
- 요약 품질 안정화
- 리뷰 본문만 모델 입력으로 전달

---

## 4. Corpus 구성

### Corpus란?
> **여러 개의 리뷰 코멘트를 하나로 합친, 요약 대상 원문 텍스트**

### 구성 방식
- 전처리된 리뷰 코멘트만 수집
- 동일한 코멘트는 중복 제거 (순서 유지)
- 리뷰 간 구분을 위해 `\n\n`으로 연결
- 최대 길이 1800자로 제한

### 예시
```
강의 내용은 좋은데 로딩이 느립니다.
영상이 자주 끊겨서 집중하기 어렵습니다.
설명은 명확하고 구성은 좋습니다.
```

이 Corpus 전체를 **하나의 문서**로 보고 요약을 수행합니다.

---

## 5. T5 요약 모델 실행

### 입력 포맷
T5 계열 모델의 특성에 맞춰 **task prefix**를 붙입니다.

### 모델 특징
- HuggingFace `pipeline("summarization")` 사용
- 프로세스 내 1회 생성 후 재사용
- 빔서치 기반 (결정적 결과)

### 생성 파라미터 정책
- `num_beams=6` : 안정적인 요약
- `do_sample=False` : 랜덤성 제거
- `max_length / min_length` : 요약 길이 통제
- 반복 억제 옵션 적용

### 목적
- 리뷰 여러 개의 **공통 불만 / 주요 장점**을 한 문장으로 압축

---

## 6. 후처리 (Post Processing)

모델 출력은 그대로 UI에 노출하기 어렵기 때문에 후처리를 수행합니다.

### 6-1. 존댓말 변환
- 정규식 룰 기반 종결어미 변환
- 예: `~이다` → `~입니다`, `~한다` → `~합니다`
- 이미 존댓말인 경우 중복 변환 방지

### 6-2. 띄어쓰기 보정
- Kiwi 형태소 분석기를 사용해 띄어쓰기 교정
- 모델 출력 특유의 어색한 띄어쓰기 개선

### 6-3. 문장부호 및 공백 정리
- 문장부호 앞 공백 제거
- 문장부호 뒤 공백 보장
- 연속 공백 정리

### 결과
- 운영자/서비스 화면에 바로 노출 가능한 한국어 문장

---

## 7. 전체 흐름 요약

```text
리뷰 입력
  ↓
입력 검증 (개수/길이 제한)
  ↓
텍스트 전처리 (노이즈 제거)
  ↓
Corpus 구성 (중복 제거 + 합치기)
  ↓
T5 요약 모델 실행
  ↓
존댓말 변환
  ↓
Kiwi 띄어쓰기 보정
  ↓
문장부호/공백 마감
  ↓
InsightSummary 반환


